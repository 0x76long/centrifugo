



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Centrifugo Documentation">
      
      
        <link rel="canonical" href="https://github.com/centrifugal/centrifugo/server/protocol/">
      
      
        <meta name="author" content="Centrifugal">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Client protocol - Centrifugo Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../theme/styles/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#client-protocol" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://github.com/centrifugal/centrifugo" title="Centrifugo Documentation" class="md-header-nav__button md-logo">
          
            <img src="../../images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Centrifugo Documentation
            </span>
            <span class="md-header-nav__topic">
              Client protocol
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/centrifugal/centrifugo/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    centrifugal/centrifugo
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://github.com/centrifugal/centrifugo" title="Centrifugo Documentation" class="md-nav__button md-logo">
      
        <img src="../../images/logo.png" width="48" height="48">
      
    </a>
    Centrifugo Documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/centrifugal/centrifugo/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    centrifugal/centrifugo
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../guide/" title="Integration Guide" class="md-nav__link">
      Integration Guide
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Server
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Server
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../channels/" title="Channels" class="md-nav__link">
      Channels
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../authentication/" title="Authentication" class="md-nav__link">
      Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../engines/" title="Engines" class="md-nav__link">
      Engines
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../admin/" title="Admin web interface" class="md-nav__link">
      Admin web interface
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/" title="Server HTTP API" class="md-nav__link">
      Server HTTP API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../recover/" title="Message recovery" class="md-nav__link">
      Message recovery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../signals/" title="Signal handling" class="md-nav__link">
      Signal handling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../connection_expiration/" title="Connection expiration" class="md-nav__link">
      Connection expiration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../private_channels/" title="Private channels" class="md-nav__link">
      Private channels
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../protobuf/" title="Protobuf protocol" class="md-nav__link">
      Protobuf protocol
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Client protocol
      </label>
    
    <a href="./" title="Client protocol" class="md-nav__link md-nav__link--active">
      Client protocol
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#client-implementation-checklist" title="Client implementation checklist" class="md-nav__link">
    Client implementation checklist
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#top-level-framing" title="Top level framing" class="md-nav__link">
    Top level framing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect" title="Connect" class="md-nav__link">
    Connect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribe" title="Subscribe" class="md-nav__link">
    Subscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unsubscribe" title="Unsubscribe" class="md-nav__link">
    Unsubscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refresh" title="Refresh" class="md-nav__link">
    Refresh
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rpc-like-calls-publish-history-presence" title="RPC-like calls: publish, history, presence" class="md-nav__link">
    RPC-like calls: publish, history, presence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asynchronous-server-to-client-messages" title="Asynchronous server-to-client messages" class="md-nav__link">
    Asynchronous server-to-client messages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ping-pong" title="Ping Pong" class="md-nav__link">
    Ping Pong
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-disconnects" title="Handle disconnects" class="md-nav__link">
    Handle disconnects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-errors" title="Handle errors" class="md-nav__link">
    Handle errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-implementation-advices" title="Client implementation advices" class="md-nav__link">
    Client implementation advices
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Transports
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Transports
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../transports/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../transports/websocket/" title="Websocket" class="md-nav__link">
      Websocket
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../transports/sockjs/" title="SockJS" class="md-nav__link">
      SockJS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Libraries
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Libraries
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../libraries/client/" title="Client libraries" class="md-nav__link">
      Client libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../libraries/api/" title="API libraries" class="md-nav__link">
      API libraries
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Deploy
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Deploy
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/packages/" title="RPM and DEB packages" class="md-nav__link">
      RPM and DEB packages
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/docker/" title="Docker image" class="md-nav__link">
      Docker image
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/nginx/" title="Nginx configuration" class="md-nav__link">
      Nginx configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/tls/" title="TLS" class="md-nav__link">
      TLS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/redis/" title="Redis HA" class="md-nav__link">
      Redis HA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/tuning/" title="OS tuning" class="md-nav__link">
      OS tuning
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Misc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/insecure_modes/" title="Insecure modes" class="md-nav__link">
      Insecure modes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/migrate/" title="Migrate from Centrifugo v1" class="md-nav__link">
      Migrate from Centrifugo v1
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#client-implementation-checklist" title="Client implementation checklist" class="md-nav__link">
    Client implementation checklist
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#top-level-framing" title="Top level framing" class="md-nav__link">
    Top level framing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect" title="Connect" class="md-nav__link">
    Connect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribe" title="Subscribe" class="md-nav__link">
    Subscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unsubscribe" title="Unsubscribe" class="md-nav__link">
    Unsubscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refresh" title="Refresh" class="md-nav__link">
    Refresh
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rpc-like-calls-publish-history-presence" title="RPC-like calls: publish, history, presence" class="md-nav__link">
    RPC-like calls: publish, history, presence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asynchronous-server-to-client-messages" title="Asynchronous server-to-client messages" class="md-nav__link">
    Asynchronous server-to-client messages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ping-pong" title="Ping Pong" class="md-nav__link">
    Ping Pong
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-disconnects" title="Handle disconnects" class="md-nav__link">
    Handle disconnects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-errors" title="Handle errors" class="md-nav__link">
    Handle errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-implementation-advices" title="Client implementation advices" class="md-nav__link">
    Client implementation advices
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/centrifugal/documentation/edit/master/docs/server/protocol.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="client-protocol">Client protocol<a class="headerlink" href="#client-protocol" title="Permanent link">&para;</a></h1>
<p>This chapter describes internal client-server protocol in details to help developers build new client libraries and understand how existing client libraries work.</p>
<p>Note that you can always look at existing client implementations in case of any questions, for example <a href="https://github.com/centrifugal/centrifuge-js">centrifuge-js</a> or <a href="https://github.com/centrifugal/centrifuge-go">centrifuge-go</a>.</p>
<h3 id="client-implementation-checklist">Client implementation checklist<a class="headerlink" href="#client-implementation-checklist" title="Permanent link">&para;</a></h3>
<p>First we will look at list of features client library should support. Depending on client implementation some features can be not implemented. If you an author of client library you can use this list as checklist.</p>
<p>!!! note
    Field and method names presented in this checklist can have different names depending on programmer&rsquo;s taste and language style guide</p>
<p>So, client:</p>
<ul>
<li>Should work both with Centrifugo and Centrifuge library based server. To work with Centrifugo client must have a method to set connection token. To work with Centrifuge lib client must provide a method to set custom headers (the only exception is browser clients where browser automatically sets headers with respect to domain rules)</li>
<li>Should allow to use JSON payload</li>
<li>Should allow to use binary payload (actually you can only implement Protobuf protocol as you can pass JSON over it)</li>
<li>Must handle cases when many different Replies received in one websocket frame. In case of JSON protocol newline-delimited JSON-streaming format is used to combine several Replies into one websocket frame. In case of Protobuf protocol varint length-prefixed format is used</li>
<li>Must survive server reload/restart and internet connection lost. In this case client must try to reconnect with exponentioal backoff strategy</li>
<li>Must have several callback methods: <code>onConnect</code>, <code>onDisconnect</code>. Depending on implementation you can also use <code>onError</code> callback for critical errors that could not be gracefully handled. </li>
<li>Should also have <code>onMessage</code> callback to handle async messages from server.</li>
<li>Must have method to subscribe on channel and set several event handlers: <code>onPublish</code>, <code>onJoin</code>, <code>onLeave</code>, <code>onSubscribeSuccess</code>, <code>onSubscribeError</code>, <code>onUnsubscribe</code>. After subscribe method called it should return <code>Subscription</code> object to caller. This subscription object in turn should have some methods: <code>publish</code>, <code>unsubscribe</code>, <code>subscribe</code>, <code>history</code>, <code>presence</code>, <code>presence_stats</code>.</li>
<li>Should have <code>publish</code> method to publish into channel without subscribing to it.</li>
<li>Should have <code>rpc</code> method to send RPC request to server.</li>
<li>Should have <code>send</code> method to send asynchronous message to server (without waiting response).</li>
<li>Should handle disconnect reason. In case of Websocket it is sent by server in CLOSE Websocket frame. This is a string containing JSON object with fields: <code>reason</code> (string) and <code>reconnect</code> (bool). Client should give users access to these fields in disconnect event and automatically follow <code>reconnect</code> advice</li>
<li>Must send periodic <code>ping</code> commands to server and thus detect broken connection. If no ping reply received from server in configured window reconnect workflow must be initiated</li>
<li>Should fully reconnect if subscription request timed out. Timeout can be configured by client library users.</li>
<li>Should send commands to server with timeout and handle timeout error - depending on method called timeout error handling can differ a bit. For example as said above timeout on subscription request results in full client reconnect workflow.</li>
<li>Should support connection token refresh mechanism</li>
<li>Should support private channel subscriptions and private subscription token refresh mechanism</li>
<li>Should automatically recover messages after reconnect and set appropriate fields in subscribe event context. Two important fields in <code>onSubscribeSuccess</code> event context are <code>recovered</code> and <code>isResubscribe</code>. First field let user know what server thinks about subscription state - were all messages recovered or not. The second field must only be true if resubscribe was caused by temporary network connection lost. If user initiated resubscribe himself (calling <code>unsubscribe</code> method and then <code>subscribe</code> method) then recover workflow should not be used and <code>isResubscribe</code> must be <code>false</code>.</li>
</ul>
<p>Below in this document we will describe protocol concepts in detail.</p>
<p>This document describes protocol specifics for Websocket transport which supports binary and text formats to transfer data. As Centrifuge has various types of messages it serializes protocol messages using JSON or Protobuf (in case of binary websockets).</p>
<p>!!! note
    SockJS works almost the same way as JSON websocket described here but has its own extra framing on top of Centrifuge protocol messages. SockJS can only work with JSON - it&rsquo;s not possible to transfer binary data over it. SockJS is only needed as fallback to Websocket in web browsers.</p>
<h3 id="top-level-framing">Top level framing<a class="headerlink" href="#top-level-framing" title="Permanent link">&para;</a></h3>
<p>Centrifuge protocol defined in <a href="https://github.com/centrifugal/centrifuge/blob/master/misc/proto/client.proto">Protobuf schema</a>. That schema is a source of truth and all protocol description below describes messages from that schema.</p>
<p>Client sends <code>Command</code> to server.</p>
<p>Server sends <code>Reply</code> to client.</p>
<p>One request from client to server and one response from server to client can have more than one <code>Command</code> or <code>Reply</code>.</p>
<p>When JSON format is used then many <code>Command</code> can be sent from client to server in JSON streaming line-delimited format. I.e. each individual <code>Command</code> encoded to JSON and then commands joined together using new line symbol <code>\n</code>:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;ch1&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;ch2&quot;</span><span class="p">}}</span>
</pre></div>


<p>For example here is how we do this in Javascript client when JSON format used:</p>
<div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">encodeCommands</span><span class="p">(</span><span class="nx">commands</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">encodedCommands</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">commands</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">commands</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">encodedCommands</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">commands</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">encodedCommands</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>!!! note
    This doc will use JSON format for examples because it&rsquo;s human-readable. Everything said here for JSON is also true for Protobuf encoded case. The only difference is how several individual <code>Command</code> or server <code>Reply</code> joined into one request – see below.</p>
<p>!!! note
    Method is made as ENUM in protobuf schema and can be sent as integer value but it&rsquo;s possible to send it as string in JSON case – this was made to make JSON protocol human-friendly.</p>
<p>When Protobuf format is used then many <code>Command</code> can be sent from client to server in length-delimited format where each individual <code>Command</code> marshaled to bytes prepended by <code>varint</code> length. See existing client implementations for encoding example.</p>
<p>The same rules relate to many <code>Reply</code> in one response from server to client. Line-delimited JSON and varint-length prefixed Protobuf.</p>
<p>For example here is how we read server response and extracting individual replies in Javascript client when JSON format used:</p>
<div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">decodeReplies</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">replies</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kr">const</span> <span class="nx">encodedReplies</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">encodedReplies</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">encodedReplies</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">encodedReplies</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kr">const</span> <span class="nx">reply</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">encodedReplies</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="nx">replies</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">reply</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">replies</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>For Protobuf case see existing client implementations for decoding example.</p>
<p>As you can see each <code>Command</code> has <code>id</code> field. This is an incremental integer field. This field will be echoed in server to client replies to commands so client could match a certain <code>Reply</code> to <code>Command</code> sent before. This is important because Websocket is asynchronous protocol where server and client both send messages at any moment and there is no builtin request-response pattern. Having <code>id</code> allows to match reply to command send before.</p>
<p>So you can expect something like this in response after sending commands to server:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="o">:</span> <span class="p">{}}</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="o">:</span> <span class="p">{}}</span>
</pre></div>


<p>Besides <code>id</code> <code>Reply</code> from server to client have two important fields: <code>result</code> and <code>error</code>.</p>
<p><code>result</code> contains useful payload object which can be different depending on <code>Reply</code>.</p>
<p><code>error</code> contains error object in case of <code>Command</code> processing resulted in some error on server. <code>error</code> is optional and if <code>Reply</code> does not have <code>error</code> then it means that <code>Command</code> processed successfuly and client can parse <code>result</code> object in an appropriate way.</p>
<p><code>error</code> objects looks like this:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;code&quot;</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;internal server error&quot;</span>
<span class="p">}</span>
</pre></div>


<p>We will talk more about error handling below.</p>
<p>The special type of <code>Reply</code> is asynchronous <code>Reply</code>. Those replies have no <code>id</code> field set (or <code>id</code> can be equal to zero). Async replies can come to client in any moment - not as reaction to issued <code>Command</code> but as message from server to client in arbitrary time. For example this can be message published into channel.</p>
<p>Centrifuge library defines several command types client can issue. And well-written client must be aware of all those commands and client workflow. Communication with Centrifuge/Centrifugo server starts with <code>connect</code> command.</p>
<h3 id="connect">Connect<a class="headerlink" href="#connect" title="Permanent link">&para;</a></h3>
<p>First of all client must dial with server and then send <code>connect</code> <code>Command</code> to it.</p>
<p>Default Websocket endpoint in Centrifugo is:</p>
<div class="codehilite"><pre><span></span>ws://centrifugo.example.com/connection/websocket
</pre></div>


<p>In case of using TLS:</p>
<div class="codehilite"><pre><span></span>wss://centrifugo.example.com/connection/websocket
</pre></div>


<p>After successful dial to websocket endpoint client must send <code>connect</code> command to server to authorize itself.</p>
<p><code>connect</code> command looks like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;token&quot;</span><span class="o">:</span> <span class="s2">&quot;JWT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Where params fields are passed to client from application backend:</p>
<ul>
<li>string <code>token</code> - connection token.</li>
<li>JSON <code>data</code> - this is only available for Centrifuge library and not for Centrifugo server. It contains custom connect data, for example it can contain client settings. </li>
</ul>
<p>In response to <code>connect</code> command server sends connect reply. It looks this way:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;client&quot;</span><span class="o">:</span><span class="s2">&quot;421bf374-dd01-4f82-9def-8c31697e956f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="s2">&quot;2.0.0&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><code>result</code> has some fields:</p>
<ul>
<li>string <code>client</code> - unique client connection ID server issued to this connection</li>
<li>string <code>version</code> - server version</li>
<li>optional bool <code>expires</code> - whether or not server will expire connection</li>
<li>optional int32 <code>ttl</code> - time in seconds until connection will expire</li>
</ul>
<h3 id="subscribe">Subscribe<a class="headerlink" href="#subscribe" title="Permanent link">&para;</a></h3>
<p>As soon as client successfully connected and got unique connection ID it is ready to
subscribe on channels. To do this it must send <code>subscribe</code> command to server:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;ch1&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Fields that can be set in <code>params</code> are:</p>
<ul>
<li>string <code>channel</code> - channel to subscribe</li>
</ul>
<p>In response to subscribe client receives reply like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{}</span>
<span class="p">}</span>
</pre></div>


<p><code>result</code> can have the following fields that relate to subscription expiration:</p>
<ul>
<li>optional bool <code>expires</code> - indicates whether subscription expires or not.</li>
<li>optional uint32 <code>ttl</code> - number of seconds until subscription expire.</li>
</ul>
<p>And several fields that relate to message recovery:</p>
<ul>
<li>optional bool <code>recoverable</code> - means that messages can be recovered in this subscription.</li>
<li>optional uint32 <code>seq</code> - current publication sequence inside channel</li>
<li>optional uint32 <code>gen</code> - current publication generation inside channel</li>
<li>optional string <code>epoch</code> - current epoch inside channel</li>
<li>optional array <code>publications</code> - this is an array of missed publications in channel. When received client must call general publication event handler for each message in this array.</li>
<li>optional bool <code>recovered</code> - this flag is set to <code>true</code> when server thinks that all missed publications were successfully recovered and send in subscribe reply (in <code>publications</code> array) and <code>false</code> otherwise.</li>
</ul>
<p>See more about meaning of recovery related fields in <a href="../recover/">special doc chapter</a>.</p>
<p>After client received successful reply on <code>subscribe</code> command it will receive asynchronous reply messages published to this channel. Messages can be of several types:</p>
<ul>
<li><code>Publication</code> message</li>
<li><code>Join</code> message</li>
<li><code>Leave</code> message</li>
<li><code>Unsub</code> message</li>
</ul>
<p>See more about asynchronous messages below. </p>
<h3 id="unsubscribe">Unsubscribe<a class="headerlink" href="#unsubscribe" title="Permanent link">&para;</a></h3>
<p>This is simple. When client wants to unsubscribe from channel and therefore stop receiving asynchronous subscription messages from connection related to channel it must call <code>unsubscribe</code> command:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;unsubscribe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;ch1&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Actually server response does not mean a lot for client - it must immediately remove channel subscription from internal implementation data structures and ignore all messages related to channel.</p>
<h3 id="refresh">Refresh<a class="headerlink" href="#refresh" title="Permanent link">&para;</a></h3>
<p>It&rsquo;s possible to turn on client connection expiration mechanism on server. While enabled server will keep track of connections whose time of life (defined by <code>exp</code> timestamp) is close to the end. In this case connection will be closed. Client can prevent closing connection refreshing it&rsquo;s connection credentials. To do this it must send <code>refresh</code> command to server. <code>refresh</code> command similar to <code>connect</code>:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;token&quot;</span><span class="o">:</span> <span class="s2">&quot;JWT&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Just with actual <code>exp</code> and new <code>sign</code>.</p>
<p>The tip whether or not connection must be refreshed comes in reply to <code>connect</code> command shown above - fields <code>expires</code> and <code>ttl</code>.</p>
<p>When client connection expire mechanism is on the value of field <code>expires</code> in connect reply is <code>true</code>. In this case client implementation should look at <code>ttl</code> value which is seconds left until connection will be considered expired. Client must send <code>refresh</code> command after this <code>ttl</code> seconds. Server gives client a configured window to refresh token after <code>ttl</code> passed and then closes connection if client have not updated its token.</p>
<p>When connecting with already expired token an error will be returned (with code <code>109</code>). In this case client should refresh its token and reconnect with exponential backoff. </p>
<h3 id="rpc-like-calls-publish-history-presence">RPC-like calls: publish, history, presence<a class="headerlink" href="#rpc-like-calls-publish-history-presence" title="Permanent link">&para;</a></h3>
<p>The mechanics of these calls is simple - client sends command and expects response from server.</p>
<p><code>publish</code> command allows to publish message into channel from client.</p>
<p>!!! note
    To publish from client <code>publish</code> option in server configuration must be set to <code>true</code></p>
<p><code>history</code> allows to ask server for channel history if enabled.</p>
<p><code>presence</code> allows to ask server for channel presence information if enabled.</p>
<h3 id="asynchronous-server-to-client-messages">Asynchronous server-to-client messages<a class="headerlink" href="#asynchronous-server-to-client-messages" title="Permanent link">&para;</a></h3>
<p>There are several types of asynchronous messages that can come from server to client. All of them relate to current client subscriptions.</p>
<p>The most important message is <code>Publication</code>:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="s2">&quot;1&quot;</span><span class="p">},</span>
            <span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;user&quot;</span><span class="o">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="s2">&quot;client&quot;</span><span class="o">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="s2">&quot;conn_info&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="s2">&quot;chan_info&quot;</span><span class="o">:</span><span class="p">{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><code>Publication</code> is a message published into channel. Note that there is no <code>id</code> field in this message - this symptom
allows to distinguish it from <code>Reply</code> to <code>Command</code>.  </p>
<p>Next message is <code>Join</code> message:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;user&quot;</span><span class="o">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="s2">&quot;client&quot;</span><span class="o">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="s2">&quot;conn_info&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="s2">&quot;chan_info&quot;</span><span class="o">:</span><span class="p">{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><code>Join</code> messages sent when someone joined (subscribed on) channel.</p>
<p>!!! note
    To enable <code>Join</code> and <code>Leave</code> messages <code>join_leave</code> option must be enabled on server globally or for channel namespace.</p>
<p><code>Leave</code> messages sent when someone left (unsubscribed from) channel.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;user&quot;</span><span class="o">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="s2">&quot;client&quot;</span><span class="o">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="s2">&quot;conn_info&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="s2">&quot;chan_info&quot;</span><span class="o">:</span><span class="p">{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>And finally <code>Unsub</code> message that means that server unsubscribed current client from channel:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>It&rsquo;s possible to distinguish between different types of asynchronous messages looking at <code>type</code> field (for <code>Publication</code> this field not set or <code>0</code>).</p>
<h3 id="ping-pong">Ping Pong<a class="headerlink" href="#ping-pong" title="Permanent link">&para;</a></h3>
<p>To maintain connection alive and detect broken connections client must periodically send <code>ping</code> commands to server and expect replies to it. Ping command looks like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span><span class="s2">&quot;ping&quot;</span>
<span class="p">}</span>
</pre></div>


<p>Server just echoes this command back. When client does not receive ping reply for some time it must consider connection broken and try to reconnect. Recommended ping interval is 25 seconds, recommended period to wait for pong is 1-5 seconds. Though those numbers can vary.</p>
<h3 id="handle-disconnects">Handle disconnects<a class="headerlink" href="#handle-disconnects" title="Permanent link">&para;</a></h3>
<p>Client should handle disconnect advices from server. In websocket case disconnect advice is sent in reason field of CLOSE Websocket frame. Reason contains string which is <code>disconnect</code> object encoded into JSON (even in case of Protobuf scenario). That objects looks like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;shutdown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reconnect&quot;</span><span class="o">:</span> <span class="kc">true</span> 
<span class="p">}</span>
</pre></div>


<p>It contains string reason of connection closing and advice to reconnect or not. Client should take this reconnect advice into account.</p>
<p>In case of network problems and random disconnect from server without well known reason client should always try to  reconnect with exponential intervals.</p>
<h3 id="handle-errors">Handle errors<a class="headerlink" href="#handle-errors" title="Permanent link">&para;</a></h3>
<p>This section contains advices to error handling in client implementations.</p>
<p>Errors can happen during various operations and can be handled in special way in context of some commands to tolerate network and server problems.</p>
<p>Errors during <code>connect</code> must result in full client reconnect with exponential backoff strategy. The special case is error with code <code>110</code> which signals that connection token already expired. As we said above client should update its connection JWT before connecting to server again.  </p>
<p>Errors during <code>subscribe</code> must result in full client reconnect in case of internal error (code <code>100</code>). And be sent to subscribe error event handler of subscription if received error is persistent. Persistent errors are errors like <code>permission denied</code>, <code>bad request</code>, <code>namespace not found</code> etc. Persistent errors in most situation mean a mistake from developers side.</p>
<p>The special corner case is client-side timeout during <code>subscribe</code> operation. As protocol is asynchronous it&rsquo;s possible in this case that server will eventually subscribe client on channel but client will think that it&rsquo;s not subscribed. It&rsquo;s possible to retry subscription request and tolerate <code>already subscribed</code> (code <code>105</code>) error as expected. But the simplest solution is to reconnect entirely as this is simpler and gives client a chance to connect to working server instance.</p>
<p>Errors during rpc-like operations can be just returned to caller - i.e. user javascript code. Calls like <code>history</code> and <code>presence</code> are idempotent. You should be accurate with unidempotent operations like <code>publish</code> - in case of client timeout it&rsquo;s possible to send the same message into channel twice if retry publish after timeout - so users of libraries must care about this case – making sure they have some protection from displaying message twice on client side (maybe some sort of unique key in payload).</p>
<h3 id="client-implementation-advices">Client implementation advices<a class="headerlink" href="#client-implementation-advices" title="Permanent link">&para;</a></h3>
<p>Here are some advices about client public API. Examples here are in Javascript language. This is just an attempt to help in developing a client - but rules here is not obligatorily the best way to implement client.</p>
<p>Create client instance:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">centrifuge</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Centrifuge</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8000/connection/websocket&quot;</span><span class="p">,</span> <span class="p">{});</span>
</pre></div>


<p>Set connection token (in case of using Centrifugo):</p>
<div class="codehilite"><pre><span></span><span class="nx">centrifuge</span><span class="p">.</span><span class="nx">setToken</span><span class="p">(</span><span class="s2">&quot;XXX&quot;</span><span class="p">)</span>
</pre></div>


<p>Connect to server:</p>
<div class="codehilite"><pre><span></span><span class="nx">centrifuge</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</pre></div>


<p>2 event handlers can be set to <code>centrifuge</code> object: <code>connect</code> and <code>disconnect</code></p>
<div class="codehilite"><pre><span></span><span class="nx">centrifuge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">centrifuge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>


<p>Client created in <code>disconnected</code> state with <code>reconnect</code> attribute set to <code>true</code> and <code>reconnecting</code> flag set to <code>false</code> . After <code>connect()</code> called state goes to <code>connecting</code>. It&rsquo;s only possible to connect from <code>disconnected</code> state. Every time <code>connect()</code> called <code>reconnect</code> flag of client must be set to <code>true</code>. After each failed connect attempt state must be set to <code>disconnected</code>, <code>disconnect</code> event must be emitted (only if <code>reconnecting</code> flag is <code>false</code>), and then <code>reconnecting</code> flag must be set to <code>true</code> (if client should continue reconnecting) to not emit <code>disconnect</code> event again after next in a row connect attempt failure. In case of failure next connection attempt must be scheduled automatically with backoff strategy. On successful connect <code>reconnecting</code> flag must be set to <code>false</code>, backoff retry must be resetted and <code>connect</code> event must be emitted. When connection lost then the same set of actions as when connect failed must be performed.</p>
<p>Client must allow to subscribe on channels:</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">subscription</span> <span class="o">=</span> <span class="nx">centrifuge</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="nx">eventHandlers</span><span class="p">);</span>
</pre></div>


<p>Subscription object created and control immediately returned to caller - subscribing must be performed asynchronously. This is required because client can automatically reconnect later so event-based model better suites for subscriptions. </p>
<p>Subscription should support several event handlers:</p>
<ul>
<li>handler for publication received from channel</li>
<li>join message handler</li>
<li>leave message handler</li>
<li>error handler</li>
<li>subscribe success event handler</li>
<li>unsubscribe event handler</li>
</ul>
<p>Every time client connects to server it must restore all subscriptions.</p>
<p>Every time client disconnects from server it must call unsubscribe handlers for all active subscriptions and then emit disconnect event.</p>
<p>Client must periodically (once in 25 secs, configurable) send ping messages to server. If pong has not beed received in 5 secs (configurable) then client must disconnect from server and try to reconnect with backoff strategy.</p>
<p>Client can automatically batch several requests into one frame to server and also must be able to handle several replies received from server in one frame.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../protobuf/" title="Protobuf protocol" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Protobuf protocol
              </span>
            </div>
          </a>
        
        
          <a href="../../transports/" title="Overview" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Overview
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>